<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Claude WebSocket Chat</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
    }
    
    .main-container {
      height: 100vh;
      overflow: hidden;
    }
    
    .sidebar {
      background: white;
      border-right: 1px solid #dee2e6;
      height: 100vh;
      overflow-y: auto;
    }
    
    .chat-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: white;
    }
    
    .chat-header {
      border-bottom: 1px solid #dee2e6;
      background: #f8f9fa;
    }
    
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    
    .message {
      margin-bottom: 1rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      max-width: 80%;
    }
    
    .message.user {
      background: #007bff;
      color: white;
      margin-left: auto;
    }
    
    .message.bot {
      background: #e9ecef;
      color: #212529;
    }
    
    .message.system {
      background: #fff3cd;
      color: #856404;
      text-align: center;
      max-width: 100%;
    }
    
    .message img {
      max-width: 100%;
      border-radius: 0.25rem;
      margin-top: 0.5rem;
    }
    
    .session-item {
      cursor: pointer;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }
    
    .session-item:hover {
      background-color: #f8f9fa;
      border-left-color: #007bff;
    }
    
    .session-item.active {
      background-color: #e3f2fd;
      border-left-color: #007bff;
    }
    
    .session-item .session-name {
      font-weight: 500;
      color: #212529;
    }
    
    .session-item .session-meta {
      font-size: 0.875rem;
      color: #6c757d;
    }
    
    .delete-session {
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .session-item:hover .delete-session {
      opacity: 1;
    }
    
    .input-container {
      border-top: 1px solid #dee2e6;
      background: #f8f9fa;
    }
    
    .prompt-editor {
      min-height: 120px;
      resize: vertical;
    }

    /* VNC viewer container */
    .vnc-container {
      height: 40vh;
      border-bottom: 1px solid #dee2e6;
      background: #000;
    }
    .vnc-container iframe {
      width: 100%;
      height: 100%;
      border: 0;
      background: #000;
    }

    /* Draggable divider between VNC and chat */
    .vnc-divider {
      height: 10px;
      background: #e9ecef;
      border-top: 1px solid #dee2e6;
      border-bottom: 1px solid #dee2e6;
      cursor: row-resize;
      position: relative;
      z-index: 5;
    }
    .vnc-divider::after {
      content: "";
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 3px;
      background: #c7cbd1;
      border-radius: 2px;
    }
    .vnc-divider:hover { background: #dee2e6; }
    .resizing * {
      cursor: row-resize !important;
      user-select: none !important;
    }
  </style>
</head>
  <body>
    <div class="container-fluid main-container">
      <div class="row h-100">
        <!-- Left Sidebar -->
        <div class="col-md-4 col-lg-3 sidebar p-0">
          <div class="p-3 border-bottom">
            <h5 class="mb-3">
              <i class="bi bi-chat-dots me-2"></i>
              Sessions
            </h5>
            
            <div class="d-grid gap-2">
                             <button id="createSessionBtn" class="btn btn-primary btn-sm">
                 <i class="bi bi-plus-circle me-1"></i>
                 New Chat
               </button>
              <button id="refreshSessionsBtn" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-clockwise me-1"></i>
                Refresh Sessions
              </button>
            </div>
            <div id="currentSession" class="mt-3 p-2 bg-light rounded text-center text-muted small">
              No active session
            </div>
          </div>
          <div id="sessionsList" class="list-group list-group-flush">
            <!-- Sessions will be loaded here -->
          </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="col-md-8 col-lg-9 chat-container p-0">
          <div id="vncSection" class="vnc-container">
            <iframe id="vncIframe" src="" allow="fullscreen"></iframe>
          </div>
          <div id="vncDivider" class="vnc-divider" title="Drag to resize"></div>
          <div class="chat-header p-3">
            <div class="d-flex align-items-center justify-content-between">
              <h4 class="mb-0">
                <i class="bi bi-robot me-2"></i>
                Claude Agent Chat
              </h4>
              <div class="btn-group">
                <button id="hideVncBtn" class="btn btn-outline-secondary btn-sm" title="Hide/Show screen">
                  <i class="bi bi-display"></i> Hide Screen
                </button>
                <button id="toggleControlBtn" class="btn btn-outline-secondary btn-sm" title="Toggle control" disabled>
                  Control: Off
                </button>
                <a id="openVncNewTab" class="btn btn-outline-secondary btn-sm" target="_blank" rel="noopener" title="Open screen in new tab">
                  <i class="bi bi-box-arrow-up-right"></i>
                </a>
              </div>
            </div>
          </div>
          <div id="messages" class="messages-container">
            <!-- Messages will appear here -->
          </div>
          <div class="input-container p-3">
            <div class="input-group">
                                                           <input 
                  type="text" 
                  id="messageInput" 
                  class="form-control" 
                  placeholder="Type your message..." 
                  value=" open calculator and make 6+6"
                >
              <button id="sendBtn" class="btn btn-primary">
                <i class="bi bi-send"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

  <script>
    let ws = null;
    let currentSessionId = null;
         const messagesDiv = document.getElementById("messages");
     const input = document.getElementById("messageInput");
     const sendBtn = document.getElementById("sendBtn");
     const createSessionBtn = document.getElementById("createSessionBtn");
     const refreshSessionsBtn = document.getElementById("refreshSessionsBtn");
     const currentSessionSpan = document.getElementById("currentSession");
     const sessionsList = document.getElementById("sessionsList");
     const vncSection = document.getElementById('vncSection');
     const vncIframe = document.getElementById('vncIframe');
     const toggleControlBtn = document.getElementById('toggleControlBtn');
     const openVncNewTab = document.getElementById('openVncNewTab');
     const vncDivider = document.getElementById('vncDivider');
     const hideVncBtn = document.getElementById('hideVncBtn');

     let vncViewOnly = true;
     function buildVncUrl() {
       const host = window.location.hostname;
       return `http://${host}:6080/vnc.html?resize=scale&autoconnect=1&view_only=${vncViewOnly ? 1 : 0}&reconnect=1&reconnect_delay=2000`;
     }

     // Initialize open-in-new-tab link
     openVncNewTab.href = `http://${window.location.hostname}:6080/vnc.html?resize=scale&autoconnect=1&view_only=1&reconnect=1&reconnect_delay=2000`;

     toggleControlBtn.onclick = () => {
       vncViewOnly = !vncViewOnly;
       toggleControlBtn.textContent = `Control: ${vncViewOnly ? 'Off' : 'On'}`;
       if (vncIframe.src) {
         vncIframe.src = buildVncUrl();
       }
     };



    function addMessage(sender, text) {
      const div = document.createElement("div");
      let messageClass = "message ";
      
      if (sender === "You") {
        messageClass += "user";
      } else if (sender === "System" || sender.includes("System")) {
        messageClass += "system";
      } else {
        messageClass += "bot";
      }
      
      div.className = messageClass;
      div.textContent = text;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addImage(base64) {
      const div = document.createElement("div");
      div.className = "message bot";
      const img = document.createElement("img");
      img.src = "data:image/png;base64," + base64;
      img.className = "img-fluid";
      img.onload = () => {};
      img.onerror = (e) => {};
      div.appendChild(img);
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }



    function clearMessages() {
      messagesDiv.innerHTML = '';
    }

         async function loadSessionHistory(sessionId) {
            fetch(`/api/session/${sessionId}/history`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.messages && Array.isArray(data.messages)) {
                        data.messages.forEach(message => {
                            if (message.role === 'user') {
                                // Handle user messages
                                if (message.content && Array.isArray(message.content)) {
                                    message.content.forEach(block => {
                                        if (block.type === 'text' && block.text) {
                                            addMessage('user', block.text);
                                        } else if (block.type === 'image' && block.source) {
                                            addImage(block.source.data);
                                        }
                                    });
                                }
                            } else if (message.role === 'assistant') {
                                // Handle assistant messages
                                if (message.content && Array.isArray(message.content)) {
                                    // Create a single container for all content blocks in this message
                                    const messageContainer = document.createElement('div');
                                    messageContainer.className = 'message assistant-message';
                                    
                                    message.content.forEach(block => {
                                        if (block.type === 'text' && block.text) {
                                            const textDiv = document.createElement('div');
                                            textDiv.className = 'message-text';
                                            textDiv.textContent = block.text;
                                            messageContainer.appendChild(textDiv);
                                        } else if (block.type === 'image') {
                                            const img = document.createElement('img');
                                            img.className = 'message-image';
                                            if (block.source && block.source.data) {
                                                img.src = `data:image/png;base64,${block.source.data}`;
                                            } else if (block.data) {
                                                img.src = `data:image/png;base64,${block.data}`;
                                            }
                                            messageContainer.appendChild(img);
                                        }
                                    });
                                    
                                    if (messageContainer.children.length > 0) {
                                        messagesDiv.appendChild(messageContainer);
                                    }
                                }
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Failed to load session history:', error);
                });
        }

    async function listSessions() {
      try {
        const response = await fetch('/api/sessions');
        if (response.ok) {
          const data = await response.json();
          sessionsList.innerHTML = '';
          
          if (data.sessions && data.sessions.length > 0) {
            data.sessions.forEach(session => {
              const sessionDiv = document.createElement('div');
              sessionDiv.className = 'list-group-item session-item d-flex justify-content-between align-items-start';
              if (session.session_id === currentSessionId) {
                sessionDiv.classList.add('active');
              }
              
              const sessionInfo = document.createElement('div');
              sessionInfo.className = 'ms-2 me-auto';
              sessionInfo.innerHTML = `
                <div class="session-name fw-bold">${session.display_name || session.session_id}</div>
                <div class="session-meta">
                  <small class="text-muted">
                    <i class="bi bi-chat me-1"></i>${session.message_count} messages
                    <i class="bi bi-clock me-1 ms-2"></i>${new Date(session.created_at).toLocaleDateString()}
                  </small>
                </div>
              `;
              
              const deleteBtn = document.createElement('button');
              deleteBtn.className = 'btn btn-sm btn-outline-danger delete-session';
              deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
              deleteBtn.onclick = (e) => {
                e.stopPropagation();
                if (confirm(`Are you sure you want to delete session "${session.display_name}"? This action cannot be undone.`)) {
                  deleteSessionById(session.session_id);
                }
              };
              
              sessionDiv.appendChild(sessionInfo);
              sessionDiv.appendChild(deleteBtn);
              
              sessionDiv.onclick = () => {
                // Load this session
                currentSessionId = session.session_id;
                currentSessionSpan.textContent = `Active: ${session.session_id}`;
                clearMessages(); // Clear messages before loading new session
                loadSessionHistory(session.session_id);
                connectWebSocket();
                
                // Update active state
                document.querySelectorAll('.session-item').forEach(item => item.classList.remove('active'));
                sessionDiv.classList.add('active');
              };
              
              sessionsList.appendChild(sessionDiv);
            });
          } else {
            sessionsList.innerHTML = `
              <div class="text-center text-muted py-4">
                <i class="bi bi-inbox display-4"></i>
                <p class="mt-2">No sessions found</p>
              </div>
            `;
          }
        }
      } catch (error) {
        addMessage("Error", "Failed to list sessions: " + error.message);
      }
    }

         async function createSession() {
       // Just create a local chat interface, don't send API request yet
       currentSessionId = null; // No session ID until first message
       currentSessionSpan.textContent = "New Chat";
       clearMessages();
       
       // Disconnect any existing WebSocket
       if (ws) {
         ws.close();
         ws = null;
       }
       
       addMessage("System", "New chat created. Type your message and click Send to start.");
     }

    async function deleteSession() {
      if (!currentSessionId) {
        addMessage("Error", "No active session to delete");
        return;
      }
      if (confirm("Are you sure you want to delete the current session? This action cannot be undone.")) {
        await deleteSessionById(currentSessionId);
      }
    }

    async function deleteSessionById(sessionId) {
      try {
        const response = await fetch(`/api/session/${sessionId}`, {
          method: 'DELETE'
        });
        if (response.ok) {
          addMessage("System", "Session deleted successfully");
          
          // If we deleted the current session, clear it
          if (sessionId === currentSessionId) {
            currentSessionId = null;
            currentSessionSpan.textContent = "No active session";
            clearMessages();
            if (ws) {
              ws.close();
              ws = null;
            }
          }
          
          // Refresh the session list
          await listSessions();
        } else {
          const errorData = await response.json().catch(() => ({}));
          addMessage("Error", `Failed to delete session: ${errorData.detail || response.statusText}`);
        }
      } catch (error) {
        addMessage("Error", "Failed to delete session: " + error.message);
      }
    }

    function connectWebSocket() {
      if (ws) {
        ws.close();
      }
      ws = new WebSocket(`ws://localhost:8081/ws/session/${currentSessionId}`);
      setupWebSocketHandlers();
    }

    function setupWebSocketHandlers() {
      ws.onopen = () => {
        addMessage("System", "Connected to session");
      };

      ws.onclose = (event) => {
        addMessage("System", "Disconnected from session");
      };

      ws.onerror = (error) => {
        const errorMessage = error.message || "Connection failed";
        addMessage("Error", "WebSocket error: " + errorMessage);
      };

      ws.onmessage = handleWebSocketMessage;
    }

    function handleWebSocketMessage(event) {
      const data = JSON.parse(event.data);
      switch (data.type) {
        case "agent_message":
          addMessage("Claude", data.message);
          // Refresh session list to update message count
          setTimeout(() => listSessions(), 100);
          break;
        case "thinking":
          addMessage("Claude (thinking)", data.message);
          break;
        case "image":
          if (data.data) addImage(data.data);
          break;
        case "tool_use":
          // Don't display tool use messages to avoid "undefined" output
          break;
        case "error":
          addMessage("Error", data.message);
          break;
      }
    }

    // Event listeners
    createSessionBtn.onclick = createSession;
    refreshSessionsBtn.onclick = listSessions;

                   // Handle Enter to send message
      input.addEventListener("keydown", function (e) {
        if (e.key === 'Enter' && !e.ctrlKey) {
          e.preventDefault();
          sendMessage();
        }
      });

                       async function sendMessage() {
         const msg = input.value.trim();
         if (!msg) return;
         
         // If no session exists, create one first
         if (!currentSessionId) {
           try {
             addMessage("You", msg);
             
             // Create session with the first message
             const response = await fetch('/api/session', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({ 
                 initial_prompt: msg
               })
             });
             
             const data = await response.json();
             if (response.ok) {
               currentSessionId = data.session_id;
               currentSessionSpan.textContent = `Active: ${data.display_name}`;
               
               // Connect WebSocket and send the message
               connectWebSocket();
               
               // Wait a bit for WebSocket to connect, then send message
               setTimeout(() => {
                 if (ws && ws.readyState === WebSocket.OPEN) {
                   ws.send(JSON.stringify({ message: msg }));
                 }
               }, 500);
               
               // Refresh session list to show the new session
               setTimeout(() => listSessions(), 1000);
             } else {
               addMessage("Error", data.message || "Failed to create session");
             }
           } catch (error) {
             addMessage("Error", "Failed to create session: " + error.message);
           }
         } else {
           // Normal message sending for existing session
           if (!ws || ws.readyState !== WebSocket.OPEN) {
             addMessage("Error", "No active session. Please create or load a session first.");
             return;
           }
           addMessage("You", msg);
           ws.send(JSON.stringify({ message: msg }));
           // Refresh session list to update message count
           setTimeout(() => listSessions(), 100);
         }
         
         input.value = "";
       }

     sendBtn.onclick = sendMessage;

    // Load sessions when page loads
    window.addEventListener('load', async () => {
      // Always show VNC and load immediately
      // Restore saved height if present
      try {
        const saved = localStorage.getItem('vncHeightPx');
        if (saved) {
          const px = parseInt(saved, 10);
          if (!Number.isNaN(px) && px > 120) {
            vncSection.style.height = px + 'px';
          }
        }
      } catch {}

      vncIframe.src = buildVncUrl();
      toggleControlBtn.disabled = false;
      await listSessions();
    });

    // Hide/Show VNC and divider
    (function enableHideShowVnc(){
      function setHidden(hidden){
        if(hidden){
          vncSection.style.display = 'none';
          vncDivider.style.display = 'none';
          hideVncBtn.innerHTML = '<i class="bi bi-display"></i> Show Screen';
          localStorage.setItem('vncHidden','1');
        } else {
          vncSection.style.display = '';
          vncDivider.style.display = '';
          hideVncBtn.innerHTML = '<i class="bi bi-display"></i> Hide Screen';
          localStorage.setItem('vncHidden','0');
        }
      }
      try{
        const hidden = localStorage.getItem('vncHidden') === '1';
        setHidden(hidden);
      } catch {}
      hideVncBtn.onclick = () => {
        const currentlyHidden = vncSection.style.display === 'none';
        setHidden(!currentlyHidden);
      };
    })();

    // Drag-to-resize logic
    (function enableVncResize() {
      let isDragging = false;
      let startY = 0;
      let startHeight = 0;
      let lastClientY = 0;
      let scheduled = false;

      function clamp(value, min, max) { return Math.max(min, Math.min(max, value)); }

      function applyResize() {
        scheduled = false;
        if (!isDragging) return;
        const dy = lastClientY - startY;
        const container = document.querySelector('.chat-container');
        const containerHeight = container.getBoundingClientRect().height;
        const minVnc = 120; // px
        const minChat = 200; // px reserved for chat area
        const maxVnc = containerHeight - minChat; // keep room for chat
        const newHeight = clamp(startHeight + dy, minVnc, Math.max(minVnc, maxVnc));
        vncSection.style.height = newHeight + 'px';
      }

      function onMove(e) {
        if (!isDragging) return;
        lastClientY = e.clientY;
        if (!scheduled) {
          scheduled = true;
          requestAnimationFrame(applyResize);
        }
      }

      function onUp() {
        if (!isDragging) return;
        isDragging = false;
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        document.body.classList.remove('resizing');
        // Re-enable iframe interaction
        vncIframe.style.pointerEvents = 'auto';
        try {
          const px = vncSection.getBoundingClientRect().height;
          localStorage.setItem('vncHeightPx', String(Math.round(px)));
        } catch {}
      }

      vncDivider.addEventListener('mousedown', (e) => {
        e.preventDefault();
        isDragging = true;
        startY = e.clientY;
        startHeight = vncSection.getBoundingClientRect().height;
        document.body.classList.add('resizing');
        // Prevent iframe from swallowing mouse events during drag
        vncIframe.style.pointerEvents = 'none';
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });
    })();
  </script>
  
  <!-- Bootstrap 5 JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
